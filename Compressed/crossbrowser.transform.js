// Copyright Sam Goody siteroller@gmail.com
// Distributed under the Creative Commons License.
var CrossBrowser=new Class({loopstop:0,loadStylesheets:function(){var c=this;$$("style").each(function(a,b){var e=c.stripComments(a.get("html"),"css");c.parse(e,b)});$$("link[rel=stylesheet]").each(function(){href.contains("://")&&href.contains(document.domain)&&new Request({onSuccess:c.parse})})},ieLoop:function(){var c=this;Array.each(document.styleSheets,function(a){Array.each(a.rules||a.cssRules,function(b){var e=b.style["moz-transform"];e&&$$(b.selectorText).each(function(d){c.loopMethod(d,e)})})})}, stripComments:function(c,a){switch(a){case "css":return c.replace(/\/\*[^*]*\*\//g,"");case "htm":return c.replace(/<!--|--\>/g,"");case "js":return c.replace(/\/\/.+?(?=\n|\r|$)|\/\*[\s\S]+?\*\//g,"").replace(/@[^\{\};]*;|@[^\{\};]*\{[^\}]*\}/g,"")}},parse:function(c,a){var b=this;a=document.styleSheets[a];c.split("}").each(function(e){b.parseObj.each(function(d){var f=e.match(d[1]);if(f)a.insertRule("{el}{{pre}-{reg}:{is}}".substitute({el:e.split("{")[0].trim(),pre:d[0]?b.pre:"",reg:f[0],is:(Type.isFunction(d[2])? d[2]:b[d[2]]).bind(b)(e.split(d[1]).pop().match(/:([^;}]+)/i)[1])}))})})}}),Transform=new Class({Implements:CrossBrowser,initialize:function(){this.pre={chrome:"-webkit",safari:"-webkit",opera:"-o",firefox:"-moz"}[Browser.name]},extendDOM:function(c){var a={},b=this;["transform","matrix","rotate","skew","skewX","skewY","scale","scaleX","scaleY","translate","translateX","translateY"].each(function(e){a[e]=function(d,f,g){if(Type.isArray(f)){g=f;f=null}d=b.getMatrix(e,d,f);b.transform(this,e,d,g);return this}}); c?$$(c).each(function(e){Object.merge(e,a)}):Element.implement(a);return this},getMatrix:function(c,a,b){c=c.toLowerCase();var e={c:"",k:"deg",r:"px",o:"deg"}[c.substr(1,1)];if(c=="transform")return this.parseRule(a);if(c=="matrix"){b=Browser.firefox?"px":0;return[a[0],a[2],a[1],a[3],a[4]||0+b,a[5]||0+b]}if(this.pre)return a+e+(b?","+b+e:"");e=c.slice(-1);var d=0.0174532925,f=+(c.substr(0,5)=="scale");if(e=="y"){b=a;a=f;c=c.slice(0,-1)}else if(e=="x"){b=f;c=c.slice(0,-1)}else if(c=="rotate"){d*=a; a=d.sin();b=d.cos()}else b||(b=f?a:0);if(c=="skew"){a=(a*d).tan();b=(b*d).tan()}return{scale:[a,0,0,b],skew:[1,b,a,1],rotate:[b,a,-a,b],translate:[1,0,0,1,a,b],squeeze:[a,0,0,1/a],project:[0,0,0,1],reflect:[1,0,0,-1],invert:[]}[c]},transform:function(c,a,b,e){if(!this.pre)return this.ieTransform(c,b,e);e=e||[50,50];c.style.position=="static"&&c.setStyle("position","relative");c.setStyle(this.pre+"-transform",a=="transform"?b:a+"("+b+")");c.setStyle(this.pre+"-transform-origin",e[0]+"px "+e[1]+"px")}, parseRule:function(c){if(Browser.firefox)return c;if(this.pre=="-webkit")return c.replace(/(matrix\s*\((?:\s*[-\.\d]+\s*,){4})(\s*\d+)[^,]*,(\s*\d+)[^)]*\)/gi,"$1$2,$3)");for(var a,b=[1,0,0,1,0,0],e=/([^(]+)\(([^)]*)\)/gi;a=e.exec(c);){var d=a[1].trim();a=a[2].split(/\s*,\s*/).map(this.convert);d=this.getMatrix(d,a[0],a[1]);b=[b[1]*d[2]+b[0]*d[0],b[2]*d[0]+b[3]*d[2],b[0]*d[1]+b[1]*d[3],b[2]*d[1]+b[3]*d[3],b[0]*d[4]+b[1]*d[5]+b[4],b[2]*d[4]+b[3]*d[5]+b[5]]}return b},convert:function(c){snum=c.trim().split(/(\d+)/); return parseFloat(c)}});Transform.implement({ieTransform:function(c,a,b){b=b||[50,50];c.setStyle(Browser.ie6?"filter":"-ms-filter",'progid:DXImageTransform.Microsoft.Matrix(M11={a}, M12={c}, M21={b}, M22={d}, SizingMethod="auto expand")'.substitute({a:a[0],b:a[1],c:a[2],d:a[3]}));var e=c.clientWidth/2-b[0],d=c.clientHeight/2-b[1],f=e*a[1]+d*a[3]+b[1]+(a[5]||0)-c.offsetHeight/2;c.style.left=e*a[0]+d*a[2]+b[0]+(a[4]||0)-c.offsetWidth/2;c.style.top=f}}); CrossBrowser.Transform=new Class({Implements:[Transform,CrossBrowser],parseStyles:function(){if(Browser.ie)this.ieLoop();else Browser.firefox||this.loadStylesheets()},parseObj:[[1,/transform(?!-)/i,"parseRule"],[1,/transform-origin/i,"parseRule"]],loopMethod:function(c,a){var b=this.parseRule(a);this.ieTransform(c,b)}});